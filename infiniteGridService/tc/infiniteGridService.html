<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
	<style>
		.cf:before,.cf:after{content:" ";display:table;}
		.cf:after{clear:both;}
	</style>
</head>
<body>
<nav class="navbar navbar-default">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="#">InfiniteGridService</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li>
				<li><a href="#">Link</a></li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li><a href="#">Action</a></li>
						<li><a href="#">Another action</a></li>
						<li><a href="#">Something else here</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="#">Separated link</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="#">One more separated link</a></li>
					</ul>
				</li>
			</ul>
			<form class="navbar-form navbar-left" role="search">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Search">
				</div>
			<button type="submit" class="btn btn-default">Submit</button>
			</form>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="#">Link</a></li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li><a href="#">Action</a></li>
						<li><a href="#">Another action</a></li>
						<li><a href="#">Something else here</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="#">Separated link</a></li>
					</ul>
				</li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
<div class="jumbotron">
	<div class="container">
		<h1>Hello, InfiniteGridService!</h1>
		<p>This is a simple hero unit, a simple jumbotron-style component for calling extra attention to featured content or information.</p>
	</div>
</div>
<div class="container">
  	<div class="row">
  		<div id="prepend-loading-bar" class="alert alert-info" role="alert" style="display:none"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> prepending...</span></div>
		<div id="grid" class="col-md-12" style="visibility:hidden"></div>
		<div class="cf"></div>
		<div id="append-loading-bar" class="alert alert-info" role="alert" style="display:none"><span class="glyphicon glyphicon-refresh" aria-hidden="true"> appending...</span></div>
	</div>
</div>

<script src="../bower_components/jquery/jquery.js"></script>
<script src="../bower_components/get-style-property/get-style-property.js"></script>
<script src="../bower_components/get-size/get-size.js"></script>
<script src="../bower_components/matches-selector/matches-selector.js"></script>
<script src="../bower_components/eventEmitter/EventEmitter.js"></script>
<script src="../bower_components/eventie/eventie.js"></script>
<script src="../bower_components/doc-ready/doc-ready.js"></script>
<script src="../bower_components/fizzy-ui-utils/utils.js"></script>
<script src="../bower_components/outlayer/item.js"></script>
<script src="../bower_components/outlayer/outlayer.js"></script>
<script src="../src/module.js"></script>
<script src="../src/eg.js"></script>
<script src="../src/class.js"></script>
<script src="../src/component.js"></script>
<script src="../src/plugin/persist.js"></script>
<script src="../src/customEvent/scrollEnd.js"></script>
<script src="../src/infiniteGrid.js"></script>
<script src="../src/infiniteGridService.js"></script>

<script>
$(document).ready(function() {
	function getContents(offset, limit) {
		var html = "";

		offset = offset || 1;
		limit = limit || 80;

		var end = offset + limit;

		for ( ; offset < end; offset ++ ) {
			html = html +
				'<div class="col-sm-6 col-md-3" data-offset="' + offset + '"><a href="http://naver.com/">' +
					'<div class="thumbnail">' +
						'<img src="http://128.199.120.3:8081/images/' + Math.floor((Math.random() * 40) + 1) + '.jpg" alt="' + offset + '">' +
						'<div class="caption">' +
							'<p>Cras justo odio, dapibus ac...</p>' +
						'</div>' +
					'</div>' +
				'</a></div>';
		}

		return html;
	};

	/**
	 * Grid 내부 아이템의 offset 인덱스 리턴
	 * @param {String} pos "first"일 경우 첫 아이템의 data-offset 리턴. "last"일 경우 마지막 아이템의 data-offset 리턴
	 * @return {Number} offset
	 */
	function getOffset(pos) {
		var offset = 0;

		if (pos === "first") {
			offset = $("#grid").children("div").first().data("offset");
		} else if (pos === "last") {
			offset = $("#grid").children("div").last().data("offset");
		} else

		offset = parseInt(offset, 10);
		return offset;
	};

	var contents;
	var limit = 80;
	var SERVER_URL = "http://128.199.120.3:8081/infiniteGrid/items";

	/*
	 eg.InfiniteGrideService 인스턴스 생성
	 InfiniteGridService 대상인 엘리먼트 셀렉터 지정
	 옵션 설정
	*/
	var infiniteGridService = new eg.InfiniteGridService("#grid");

	/*
	 "append" 이벤트 핸들러
	 스크롤 다운 중 최하단 아이템이 화면에 보여질 때(threshold로 보정 가능)
	 threshold가 300이면 최하단 아이템이 화면에 보여지기 300px 전에 이벤트 발생
	 로딩바를 보이고 appendAjax 메소드를 호출해 서버에 데이터를 요청함.
	 응답데이터가 #grid에 append 됨
	 */
	infiniteGridService.on("append", function() {
		var offset = getOffset("last");
		$("#append-loading-bar").show();
//		var url = SERVER_URL + "?offset=" + (offset + 1) + "&limit=" + limit;
//		infiniteGridService.appendAjax(url);
//		var options = {
//			url: url,
//			jsonp: "callback"
//		};
//		infiniteGridService.appendAjax(options);
		var contents = getContents(offset + 1, limit);
		infiniteGridService.append(contents);
	});

	/*
	 "preppend" 이벤트 핸들러
	 스크롤 업 중 최상단 아이템이 화면에 보여질 때(threshold로 보정 가능)
	 threshold가 300이면 최하단 아이템이 화면에 보여지기 300px 전에 이벤트 발생
	 로딩바를 보이고 prependAjax 메소드를 호출해 서버에 데이터를 요청
	 응답데이터가 #grid에 preppend 되고 스크롤 위치가 보정
	 */
	infiniteGridService.on("prepend", function() {
		var offset = getOffset("first");
		offset = offset - limit;
		if( offset > 0) {
			$("#prepend-loading-bar").show();
//			var url = SERVER_URL + "?offset=" + offset + "&limit=" + limit;
//			infiniteGridService.prependAjax(url, function(data) {
//				return $(data);
//			});
//			var options = {
//				url: url,
//				jsonp: "callback"
//			};
//			infiniteGridService.prependAjax(options, function(data) {
//				return $(data);
//			});
			var contents = getContents(offset, limit);
			infiniteGridService.prepend(contents);
		}
	});

	/*
	 "layoutComplete" 이벤트 핸들러
	 append, preppend가 완료되면 발생
	 이벤트 파라미터를 통해 append인지 prepend인지 확인 가능
	 로딩바 감춤
	 */
	infiniteGridService.on("layoutComplete", function(e) {
		if(e.isAppend) {
			$("#append-loading-bar").hide();
		} else {
			$("#prepend-loading-bar").hide();
		}
		$("#grid").css("visibility", "visible");
	});

	infiniteGridService.on("beforeStore", function(data) {
		/// execte
		//this.setData(data)
	})

	/*
	 아이템의 <a> 클릭시 persist 데이터를 저장
	 */
	$("#grid").on("click", "a", function() {
		infiniteGridService.store();
	});

	/*
	 persist 데이터를 복원함
	 복원하지 못한다면 새로운 데이터를 요청함
	 */
	if (!infiniteGridService.restore()) {
//		var url = SERVER_URL + "?offset=1&limit=" + limit;
//		infiniteGridService.appendAjax(url);
//		var options = {
//			url: url,
//			jsonp: "callback"
//		};
//		infiniteGridService.appendAjax(options);
		var contents = getContents(1, limit);
		infiniteGridService.append(contents);
	}
});
</script>
</body>
</html>